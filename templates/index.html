<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Giustizia Scraper</title>
  <link rel="stylesheet" href="../static/styles.css">
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>🏛️ Giustizia Scraper</h1>
      <p>Cerca ricorsi nel database del Consiglio di Stato</p>
    </div>

    <!-- Connection status -->
    <div class="status" id="conn">🟡 Connessione…</div>

    <!-- Search form -->
    <form id="search-form">
      <div class="form-group">
        <label for="tribunale">Tribunale:</label>
        <select id="tribunale" name="tribunale" required>
          <option value="Consiglio di Stato">Consiglio di Stato</option>
          <option value="TAR Lazio">TAR Lazio</option>
          <!-- Add more tribunali here -->
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="year">Anno:</label>
          <input type="number" id="year" name="year" min="2000" max="2025" value="2025" required>
        </div>
        <div class="form-group">
          <label for="precision">Precisione ricerca (0-100):</label>
          <input type="number" id="fuzz_threshold" name="fuzz_threshold" min="0" max="100" value="90" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startNum">Numero ricorso iniziale:</label>
          <input type="number" id="start_num" name="start_num" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label for="endNum">Numero ricorso finale:</label>
          <input type="number" id="end_num" name="end_num" min="1" value="10" required>
        </div>
      </div>

      <div class="form-group">
        <label for="keywords">Parole chiave (una per riga):</label>
        <textarea id="keywords" name="keywords" placeholder="Inserisci le parole chiave da cercare, una per riga..."
          required></textarea>
      </div>
      <div class="btn-container">
        <button type="submit" class="btn-primary" id="startBtn">🔍 Avvia Ricerca</button>
      </div>
    </form>
    <hr />

    <!-- Progress -->
    <div class="progress-container" id="progressContainer">
      <h3 id="progressStatus">Ricerca in corso...</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="results-container" id="resultsContainer">
    <div class="results-header">
      <h2>📋 Risultati della Ricerca</h2>
      <p id="resultsCount"></p>
    </div>
    <table class="results-table">
      <thead>
        <tr>
          <th>Parola Chiave</th>
          <th>Numero Ricorso</th>
          <th>Dettagli</th>
        </tr>
      </thead>
      <tbody id="matches-log"></tbody>
    </table>
  </div>

  <!-- Socket.IO script -->
  <script type="module">
    import { io } from "https://cdn.socket.io/4.8.1/socket.io.esm.min.js";
    const socket = io({ transports: ['websocket', 'polling'] });

    const connStatus = document.getElementById('conn');
    const form = document.getElementById('search-form');
    const startBtn = document.getElementById('startBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progress-fill');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressStatus = document.getElementById('progressStatus');
    const resultsContainer = document.getElementById('resultsContainer');
    const matchesLog = document.getElementById('matches-log');
    const resultsCount = document.getElementById('resultsCount');

    let matchCounter = 0;

    socket.on('debug_log', (data) => {
      console.log(`[DEBUG] Step: ${data.step}`, data);
    });

    // Connection events
    socket.on('connect', () => {
      connStatus.textContent = '🟢 Connesso';
    });
    socket.on('connect_error', (err) => {
      connStatus.textContent = '🔴 Errore di connessione: ' + (err?.message || err);
      console.error(err);
    });
    socket.on('disconnect', () => {
      connStatus.textContent = '🟠 Disconnesso';
    });

    // Form submit
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      matchCounter = 0;
      matchesLog.innerHTML = '';
      resultsCount.textContent = '';
      resultsContainer.style.display = 'none';

      const payload = {
        tribunale: document.getElementById('tribunale').value,
        year: parseInt(document.getElementById('year').value, 10),
        start_num: parseInt(document.getElementById('start_num').value, 10),
        end_num: parseInt(document.getElementById('end_num').value, 10),
        fuzz_threshold: parseInt(document.getElementById('fuzz_threshold').value, 10),
        keywords: document.getElementById('keywords').value.split('\n').map(k => k.trim()).filter(k => k)
      };

      console.log("[DEBUG] Sending start_search event. Payload: ", payload);
      socket.emit('start_search', payload);
      startBtn.disabled = true;
      progressContainer.style.display = 'block';
    });

    // Progress updates
    socket.on('progress_update', (data) => {
      progressFill.style.width = `${data.percentage.toFixed(1)}%`;
      progressPercentage.textContent = `${data.percentage.toFixed(1)}%`;
      progressStatus.textContent = data.status;
      if (data.current === data.total) {
        startBtn.disabled = false;
      }
    });

    // Match found
    socket.on('match_found', (data) => {
      matchCounter++;
      const row = document.createElement('tr');
      const detailsId = `details-${matchCounter}`;

      row.innerHTML = `
      <td><span class="keyword-tag">${data.keyword}</span></td>
      <td class="case-number">
        <a href="#" data-target="${detailsId}" class="toggle-details">${data.case_number}</a>
      </td>
      <td>
        <div id="${detailsId}" class="case-details" style="display:none; max-width:400px; white-space:pre-wrap;">
          ${data.content || '<em>(Nessun testo trovato)</em>'}
        </div>
      </td>
    `;

      matchesLog.appendChild(row);
      resultsCount.textContent = `${matchCounter} risultati trovati`;
      resultsContainer.style.display = 'block';
    });

    // Toggle details click
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('toggle-details')) {
        e.preventDefault();
        const targetId = e.target.getAttribute('data-target');
        const detailsEl = document.getElementById(targetId);
        if (detailsEl) {
          const isHidden = detailsEl.style.display === 'none';
          detailsEl.style.display = isHidden ? 'block' : 'none';
          detailsEl.classList.toggle('show', isHidden);
        }
      }
    });
  </script>
</body>

</html>

