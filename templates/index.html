<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giustizia Scraper</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Ricerca Ricorsi</h1>

    <!-- Form with textarea for keywords -->
    <form id="search-form">
        <label>Anno:
            <input type="number" id="year" name="year" required>
        </label>
        <label>Numero iniziale:
            <input type="number" id="start_num" name="start_num" required>
        </label>
        <label>Numero finale:
            <input type="number" id="end_num" name="end_num" required>
        </label>
        <label>Keywords (una per riga):
            <textarea id="keywords" name="keywords" placeholder="Inserisci una parola per riga"></textarea>
        </label>
        <label>Soglia Fuzz:
            <input type="number" id="fuzz_threshold" name="fuzz_threshold" value="80" required>
        </label>
        <button type="submit">Avvia ricerca</button>
    </form>

    <hr>

    <!-- Progress -->
    <div>
        <strong>Progress:</strong> <span id="progress-text">0%</span>
    </div>

    <!-- Timeout Warnings -->
    <h2>Timeout Warnings</h2>
    <div id="timeout-log" class="log-box"></div>

    <!-- Raw valoreOggetto -->
    <h2>Raw valoreOggetto</h2>
    <div id="raw-log" class="log-box"></div>

    <!-- Matches -->
    <h2>Matches</h2>
    <div id="matches-log" class="log-box"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();

        socket.on('progress_update', data => {
            document.getElementById('progress-text').innerText =
                `${data.percentage.toFixed(2)}% - ${data.status}`;
        });

        socket.on('timeout_warning', data => {
            const log = document.getElementById('timeout-log');
            const entry = document.createElement('div');
            entry.classList.add('log-entry', 'timeout');
            entry.innerText = `⚠️ Timeout on ${data.case_number}: ${data.reason}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        });

        socket.on('raw_content', data => {
            const log = document.getElementById('raw-log');
            const entry = document.createElement('div');
            entry.classList.add('log-entry', 'raw');
            entry.innerText = `[${data.case_number}] ${data.content}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        });

        socket.on('match_found', data => {
            const log = document.getElementById('matches-log');
            const entry = document.createElement('div');
            entry.classList.add('log-entry', 'match');
            entry.innerText = `✅ Match in ${data.case_number} — Keyword: "${data.keyword}" (Score: ${data.score})`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        });

        // Handle form submit
        document.getElementById('search-form').addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const payload = {
                year: formData.get('year'),
                start_num: parseInt(formData.get('start_num')),
                end_num: parseInt(formData.get('end_num')),
                fuzz_threshold: parseInt(formData.get('fuzz_threshold')),
                keywords: formData.get('keywords').split('\n').map(k => k.trim()).filter(Boolean)
            };

            socket.emit('start_search', payload);
        });
    </script>
</body>
</html>
