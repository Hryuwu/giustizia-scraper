<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giustizia Scraper</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Giustizia Scraper</h1>
            <p>Cerca ricorsi nel database del Consiglio di Stato</p>
        </div>
        
        <div class="form-container">
            <form id="scraperForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="year">Anno:</label>
                        <input type="number" id="yearInput" name="year" min="2000" max="2025" value="2024" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="precision">Precisione ricerca (0-100):</label>
                        <input type="number" id="precisionInput" name="precision" min="0" max="100" value="90" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="startNum">Numero iniziale:</label>
                        <input type="number" id="startNumInput" name="startNum" min="1" value="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endNum">Numero finale:</label>
                        <input type="number" id="endNumInput" name="endNum" min="1" value="100" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="keywords">Parole chiave (una per riga):</label>
                    <textarea id="keywords" name="keywordsInput" placeholder="Inserisci le parole chiave da cercare, una per riga..." required></textarea>
                </div>
                
                <div class="btn-container">
                    <button type="submit" class="btn-primary" id="startBtn">üîç Avvia Ricerca</button>
                </div>
            </form>
            
            <div class="progress-container" id="progressContainer">
                <h3 id="progressText">Ricerca in corso...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressStatus">0 / 0 ricorsi processati</p>
            </div>
        </div>
        
        <div class="results-container" id="resultsContainer">
            <div class="results-header">
                <h2>üìã Risultati della Ricerca</h2>
                <p id="resultsCount"></p>
            </div>
            
            <table class="results-table" id="resultsTable">
                <thead>
                    <tr>
                        <th>Parola Chiave</th>
                        <th>Numero Ricorso</th>
                        <th>Anno</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>
<!-- Add this in the <head> or just before closing </body> -->
<script src="/socket.io/socket.io.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const socket = io();

    // Example: when user clicks "Start Scrape" button
    document.getElementById("startScrapeBtn").addEventListener("click", function () {
      const year = document.getElementById("yearInput").value;
      const startNum = parseInt(document.getElementById("startNumInput").value, 10);
      const endNum = parseInt(document.getElementById("endNumInput").value, 10);
      const keywords = document.getElementById("keywordsInput").value.split(",").map(k => k.trim());
      const precision = parseInt(document.getElementById("precisionInput").value, 10);

      // Send start event to backend
      socket.emit("start_scrape", { year, startNum, endNum, keywords, precision });
      
      // Clear previous output
      clearResults();
    });

    // Receive progress updates from backend
    socket.on("progress_update", function(data) {
      updateProgress(data.current, data.total, data.percentage, data.status);
    });

    // Receive keyword hit results
    socket.on("result_found", function(data) {
      addResult(data.keyword, data.case_number, data.match_score, data.match_method);
    });

    // Scraping complete event
    socket.on("scraping_complete", function(data) {
      showCompleteMessage(data.total_found);
    });
    
    // Scraping error event
    socket.on("scraping_error", function(data) {
      showError(data.error);
    });

    // Add helper functions:
    function updateProgress(current, total, percentage, status) {
      // Update progress bar and status text in your page
      document.getElementById("progressBar").value = percentage;
      document.getElementById("statusText").textContent = status;
      document.getElementById("progressText").textContent = `${current} / ${total}`;
    }
    
    function addResult(keyword, caseNumber, score, method) {
      const resultsDiv = document.getElementById("results");
      const item = document.createElement("div");
      item.textContent = `Keyword "${keyword}" found in case ${caseNumber} (score: ${score}, method: ${method})`;
      resultsDiv.appendChild(item);
    }
    
    function showCompleteMessage(totalFound) {
      alert(`Scraping complete! Total matches found: ${totalFound}`);
    }
    
    function showError(errorMsg) {
      alert(`Error during scraping: ${errorMsg}`);
    }
    
    function clearResults() {
      document.getElementById("results").innerHTML = "";
      document.getElementById("progressBar").value = 0;
      document.getElementById("statusText").textContent = "";
      document.getElementById("progressText").textContent = "";
    }
  });
</script>
</body>
</html>
