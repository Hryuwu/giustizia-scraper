<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ricerca Ricorsi</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log-box { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
        .log-entry { margin-bottom: 5px; }
        .match { background-color: #d4edda; padding: 5px; border: 1px solid #c3e6cb; }
        .timeout { background-color: #f8d7da; padding: 5px; border: 1px solid #f5c6cb; color: #721c24; }
        .raw { background-color: #e2e3e5; padding: 5px; border: 1px solid #d6d8db; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Ricerca Ricorsi</h1>

    <!-- Your existing form -->
    <form id="search-form">
        <label>Anno:
            <input type="number" id="year" name="year" required>
        </label>
        <label>Numero iniziale:
            <input type="number" id="start_num" name="start_num" required>
        </label>
        <label>Numero finale:
            <input type="number" id="end_num" name="end_num" required>
        </label>
        <label>Keywords file:
            <input type="file" id="keywords" name="keywords" required>
        </label>
        <label>Soglia Fuzz:
            <input type="number" id="fuzz_threshold" name="fuzz_threshold" value="80" required>
        </label>
        <button type="submit">Avvia ricerca</button>
    </form>

    <hr>

    <!-- Progress -->
    <div>
        <strong>Progress:</strong> <span id="progress-text">0%</span>
    </div>

    <!-- Timeout Warnings -->
    <h2>Timeout Warnings</h2>
    <div id="timeout-log" class="log-box"></div>

    <!-- Raw valoreOggetto -->
    <h2>Raw valoreOggetto</h2>
    <div id="raw-log" class="log-box"></div>

    <!-- Matches -->
    <h2>Matches</h2>
    <div id="matches-log" class="log-box"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();

        // Progress update with elapsed time
        socket.on('progress_update', data => {
            document.getElementById('progress-text').innerText =
                `${data.percentage.toFixed(2)}% - ${data.status}`;
        });

        // Timeout warnings
        socket.on('timeout_warning', data => {
            const log = document.getElementById('timeout-log');
            const entry = document.createElement('div');
            entry.classList.add('log-entry', 'timeout');
            entry.innerText = `⚠️ Timeout on ${data.case_number}: ${data.reason}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        });

        // Raw valoreOggetto
        socket.on('raw_content', data => {
            const log = document.getElementById('raw-log');
            const entry = document.createElement('div');
            entry.classList.add('log-entry', 'raw');
            entry.innerText = `[${data.case_number}] ${data.content}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        });

        // Matches found
        socket.on('match_found', data => {
            const log = document.getElementById('matches-log');
            const entry = document.createElement('div');
            entry.classList.add('log-entry', 'match');
            entry.innerText = `✅ Match in ${data.case_number} — Keyword: "${data.keyword}" (Score: ${data.score})`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        });

        // Handle form submission (send to backend via Socket.IO)
        document.getElementById('search-form').addEventListener('submit', e => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const payload = {
                year: formData.get('year'),
                start_num: parseInt(formData.get('start_num')),
                end_num: parseInt(formData.get('end_num')),
                fuzz_threshold: parseInt(formData.get('fuzz_threshold'))
            };

            const file = formData.get('keywords');
            const reader = new FileReader();
            reader.onload = function(evt) {
                payload.keywords = evt.target.result.split('\n').map(k => k.trim()).filter(Boolean);
                socket.emit('start_search', payload);
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
